name: Telegram Ship Poller

on:
  schedule:
    - cron: "*/5 * * * *" # every 5 minutes
  workflow_dispatch:

jobs:
  poll:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pytz

      - name: Restore state cache
        uses: actions/cache@v4
        with:
          path: tg_state.json
          key: tg-state

      - name: Run poller
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: "238376703"
          TZ: "Asia/Manila"
        run: |
          python - << 'EOF'
          import os, json, requests
          from datetime import datetime
          import pytz

          TOKEN = os.getenv("TELEGRAM_TOKEN")
          CHAT_ID = int(os.getenv("CHAT_ID"))
          TZ = os.getenv("TZ", "Asia/Manila")

          def tg(method, payload=None):
              url = f"https://api.telegram.org/bot{TOKEN}/{method}"
              r = requests.post(url, data=payload or {})
              r.raise_for_status()
              return r.json()

          # Time gate: only after 7PM Manila
          tz = pytz.timezone(TZ)
          now = datetime.now(tz)
          if now.hour < 19:
              print("Before 7 PM. Exiting.")
              raise SystemExit(0)

          # Load last processed update_id
          state_file = "tg_state.json"
          last_update_id = None
          try:
              with open(state_file, "r") as f:
                  last_update_id = json.load(f).get("last_update_id")
          except FileNotFoundError:
              pass

          params = {}
          if last_update_id is not None:
              params["offset"] = last_update_id + 1

          updates = tg("getUpdates", params).get("result", [])
          max_update_id_seen = last_update_id

          for u in updates:
              uid = u.get("update_id")
              if uid is not None:
                  max_update_id_seen = max(max_update_id_seen or uid, uid)

              msg = u.get("message") or {}
              chat = msg.get("chat") or {}
              from_id = chat.get("id")
              text = (msg.get("text") or "").strip()

              if from_id == CHAT_ID and text == "/ship":
                  tg("sendMessage", {"chat_id": CHAT_ID, "text": "ðŸšš Shipping startedâ€¦ (stub)"})

          if max_update_id_seen is not None:
              with open(state_file, "w") as f:
                  json.dump({"last_update_id": max_update_id_seen}, f)

          print("Done.")
          EOF

      - name: Save state cache
        uses: actions/cache@v4
        with:
          path: tg_state.json
          key: tg-state
